# 振る舞いを変えない
リファクタリングにおいて最も重要な原則は「外部から見た振る舞いを変えない」ことです。

Martin Fowler は著書『Refactoring: Improving the Design of Existing Code』[^1] において、リファクタリングを「外部から見た振る舞いを変えずに、内部の構造を改善すること」と定義しています。


## 「振る舞いを変えない」とは具体的に何を意味するか？

「振る舞いを変えない」とは以下のことを保証することです。

|保証するもの|説明|
|---|---|
|機能的な出力が同一|同じ入力に対して同じ出力が得られる|
|副作用が同一|データベース操作、ファイル操作、API呼び出しなどの外部システムとのやり取りが変わらない|
|エラー処理が同一|例外発生条件や処理が変わらない|
|パフォーマンス特性が著しく劣化しない|処理時間やリソース使用量が極端に悪化しない|

つまり、ユーザーやほかのシステムから見たとき、リファクタリング前後で違いが分からないことが理想です。


## なぜ「振る舞いを変えない」ことが重要なのか
ソフトウェアは日々メンテナンスされ、修正・拡張が繰り返されます。その過程で、予期せぬバグを生まないことが極めて重要です。

|理由|説明|
|---|---|
|リスク管理|機能変更とコード改善を分離することで、リスクを最小化できます|
|検証の容易さ|動作が同じであれば、「正しくリファクタリングできたか」の判断が明確|
|段階的改善|小さなステップで安全に改善を積み重ねられる|
|ビジネス価値の保護|既存機能の価値を損なわずに技術的負債を返却できる|

「振る舞いを変えない」ことを前提にリファクタリングすることで、現在の仕様を壊すことなく、保守性や拡張性を高めることができます。


## テストコードの重要性

「振る舞いを変えない」ことを保証するために、テストコードは不可欠です。
なぜなら、「振る舞いが変わっていないかどうか」は、人間の目では保証できないからです。

### テストコードのメリット

1. **安全網としての機能**: テストは「振る舞いが変わっていないこと」を客観的に証明する手段となります
2. **継続的な検証**: リファクタリング中・後に繰り返しテストを実行することで、常に動作を検証できます
3. **リグレッションの防止**: 意図しない変更による機能低下を早期に発見できます
4. **自信を持った改善**: 充実したテストがあれば大胆なリファクタリングも安心して実施できます

### リファクタリングに有用なテスト
リファクタリングの前後でテストがすべてグリーン（成功）であれば、「振る舞いが変わっていない」ことを機械的に確認できます。特に次のようなテストが役立ちます。

- ユニットテスト：小さな関数単位で、出力や副作用を検証
- 統合テスト：複数のコンポーネントが正しく連携しているかを確認
- スナップショットテスト：UIなどの出力結果が変化していないかを比較

つまり、テストコードはリファクタリングのセーフティネットです。十分なテストがあって初めて、安心して内部構造を大胆に変えることができます。


## 実践的なアプローチ

「振る舞いを変えない」リファクタリングを実現するためには、以下のアプロートが有用です。

|アプローチ|説明|
|---|---|
|事前にテストを整備|リファクタリング前に十分なテストカバレッジを確保する|
|小さな変更を積み重ねる|一度に大きく変更せず、テストが通る小さな変更を積み重ねる|
|頻繁にテストを実行|変更のたびにテストを実行し、振る舞いが保たれていることを確認する|
|リファクタリングとバグ修正・機能追加を混ぜない|一つのコミットやプルリクエストでは、リファクタリングか機能変更のどちらか一方だけを行う|

「振る舞いを変えない」という原則を守ることで、コードの内部品質を継続的に向上させながら、ビジネス価値を守ることができます。それがリファクタリングの本質です。

----
[^1]: Martin Fowler, *Refactoring: Improving the Design of Existing Code*, Addison-Wesley, 2nd Edition, 2018.